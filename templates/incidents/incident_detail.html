{% extends "base.html" %}
{% block title %}Incident #{{ incident.id }}{% endblock %}
{% block content %}
    <div class="container-fluid py-3">
        <!-- Header with Status + Actions -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h4 class="mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>Incident #{{ incident.id }}
            </h4>
            <div>
                {% if incident.status == 'closed' %}
                    <span class="badge bg-success">{{ incident.get_status_display }}</span>
                {% elif incident.status == 'action_required' %}
                    <span class="badge bg-danger">{{ incident.get_status_display }}</span>
                {% elif incident.status == 'assigned' %}
                    <span class="badge bg-warning">{{ incident.get_status_display }}</span>
                {% elif incident.status == 'submitted' %}
                    <span class="badge bg-info">{{ incident.get_status_display }}</span>
                {% else %}
                    <span class="badge bg-secondary">{{ incident.get_status_display }}</span>
                {% endif %}
                {% if incident.is_sensitive %}<span class="badge bg-dark ms-1">Sensitive</span>{% endif %}
            </div>
        </div>
        <!-- Actions -->
        <div class="d-flex flex-wrap justify-content-end mb-4 gap-2">
            {# EDIT #}
            {% if perms.incidents.change_incident and incident.status != 'closed' %}
                {% if not incident.assigned_to or incident.assigned_to == user %}
                    <a href="{% url 'incidents:edit' incident.pk %}"
                       class="btn btn-outline-secondary">
                        <i class="fas fa-edit me-1"></i> Edit
                    </a>
                {% endif %}
            {% endif %}
            {# ASSIGN TO ME #}
            {% if perms.incidents.can_action_incident and incident.status == 'submitted' and not incident.assigned_to %}
                <form method="post"
                      action="{% url 'incidents:assign_to_me' incident.pk %}"
                      class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-primary">
                        <i class="fas fa-user-check me-1"></i> Assign to me
                    </button>
                </form>
            {% endif %}
            {# UNASSIGN / CLOSE FLOW #}
            {% if perms.incidents.can_action_incident and incident.assigned_to == user %}
                {% if incident.status == 'assigned' %}
                    <form method="post"
                          action="{% url 'incidents:mark_action_required' incident.pk %}"
                          class="d-inline">
                        {% csrf_token %}
                        <button class="btn btn-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i> Mark action required
                        </button>
                    </form>
                    <form method="post"
                          action="{% url 'incidents:close' incident.pk %}"
                          class="d-inline">
                        {% csrf_token %}
                        <button class="btn btn-success">
                            <i class="fas fa-check me-1"></i> Close (no action)
                        </button>
                    </form>
                {% elif incident.status == 'action_required' %}
                    <form method="post"
                          action="{% url 'incidents:close' incident.pk %}"
                          class="d-inline">
                        {% csrf_token %}
                        <button class="btn btn-success">
                            <i class="fas fa-clipboard-check me-1"></i> Close (actions done)
                        </button>
                    </form>
                {% endif %}
                {% if incident.status == 'assigned' or incident.status == 'action_required' %}
                    <form method="post"
                          action="{% url 'incidents:unassign' incident.pk %}"
                          class="d-inline">
                        {% csrf_token %}
                        <button class="btn btn-outline-secondary">
                            <i class="fas fa-user-times me-1"></i> Unassign
                        </button>
                    </form>
                {% endif %}
            {% endif %}
            {# REVIEW #}
            {% if perms.incidents.can_action_incident %}
                <a href="{% url 'incidents:action' incident.pk %}"
                   class="btn btn-outline-info">
                    <i class="fas fa-tasks me-1"></i> Review form
                </a>
            {% endif %}
        </div>
        <!-- Main Content -->
        <div class="row">
            <!-- LEFT column -->
            <div class="col-lg-8">
                <!-- Summary -->
                <div class="card mb-3 shadow-sm rounded-3">
                    <div class="card-header">
                        <h5 class="mb-0">Summary</h5>
                    </div>
                    <div class="card-body">
                        <p>
                            <span class="text-muted">Date/Time:</span> {{ incident.incident_datetime|date:"D j M Y, H:i" }}
                        </p>
                        <p>
                            <span class="text-muted">Location:</span> {{ incident.location|default:"—" }}
                        </p>
                        <p>
                            <span class="text-muted">Activity:</span> {{ incident.get_activity_type_display }}
                            {% if incident.team %}· {{ incident.team }}{% endif %}
                        </p>
                        <p>
                            <span class="text-muted">Involved:</span> {{ incident.get_role_involved_display }}
                            {% if incident.primary_player %}· {{ incident.primary_player }}{% endif %}
                            {% if incident.age_under_18 %}<span class="badge bg-warning ms-1">U18</span>{% endif %}
                        </p>
                        <p>
                            <span class="text-muted">Concussion suspected:</span> {{ incident.suspected_concussion|yesno:"Yes,No" }}
                        </p>
                        <p>
                            <span class="text-muted">Treatment:</span> {{ incident.get_treatment_level_display }}
                        </p>
                        <hr>
                        <p>
                            <strong>Summary:</strong> {{ incident.summary }}
                        </p>
                        <p>
                            <strong>Description:</strong>
                            <br>
                            {{ incident.description|linebreaks }}
                        </p>
                        {% if incident.injury_types %}
                            <hr>
                            <p>
                                <strong>Injury Types:</strong> {{ incident.injury_types }}
                            </p>
                        {% endif %}
                    </div>
                </div>
                <!-- Safeguarding -->
                <div class="card mb-3 shadow-sm rounded-3">
                    <div class="card-header">
                        <h5 class="mb-0">Safeguarding & Reporting</h5>
                    </div>
                    <div class="card-body">
                        <p>
                            <span class="text-muted">Safeguarding Notified:</span> {{ incident.safeguarding_notified|yesno:"Yes,No" }}
                        </p>
                        {% if incident.safeguarding_notes %}
                            <p>
                                <span class="text-muted">Notes:</span>
                                <br>
                                {{ incident.safeguarding_notes|linebreaks }}
                            </p>
                        {% endif %}
                        <hr>
                        <p>
                            <span class="text-muted">Submitted to England Hockey:</span> {{ incident.submitted_to_eh|yesno:"Yes,No" }}
                        </p>
                        {% if incident.eh_submission_datetime %}
                            <p>
                                <span class="text-muted">Submission Date:</span> {{ incident.eh_submission_datetime|date:"Y-m-d H:i" }}
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- RIGHT column -->
            <div class="col-lg-4">
                <!-- Meta -->
                <div class="card mb-3 shadow-sm rounded-3">
                    <div class="card-header">
                        <h5 class="mb-0">Meta</h5>
                    </div>
                    <div class="card-body">
                        <p>
                            <span class="text-muted">Assigned to:</span> {{ incident.assigned_to|default:"—" }}
                        </p>
                        {% if incident.assigned_at %}
                            <p>
                                <span class="text-muted">Assigned at:</span> {{ incident.assigned_at|date:"Y-m-d H:i" }}
                            </p>
                        {% endif %}
                        <hr>
                        <p>
                            <span class="text-muted">Reported by:</span> {{ incident.reported_by|default:"—" }}
                        </p>
                        <p>
                            <span class="text-muted">Reported at:</span> {{ incident.reported_at|date:"Y-m-d H:i" }}
                        </p>
                        {% if incident.attachments %}
                            <hr>
                            <a href="{{ incident.attachments.url }}"
                               class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-paperclip me-1"></i> Download attachment
                            </a>
                        {% endif %}
                    </div>
                </div>
                <!-- Quick Facts -->
                <div class="card shadow-sm rounded-3">
                    <div class="card-header">
                        <h5 class="mb-0">Quick facts</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <span class="chip"><i class="far fa-clock me-1"></i>{{ incident.incident_datetime|date:"D j M Y, H:i" }}</span>
                        </div>
                        <div class="mb-2">
                            <span class="chip"><i class="fas fa-map-marker-alt me-1"></i>{{ incident.location|default:"—" }}</span>
                        </div>
                        <div class="mb-2">
                            <span class="chip"><i class="fas fa-users me-1"></i>{{ incident.team|default:"—" }}</span>
                        </div>
                        <div>
                            <span class="chip"><i class="fas fa-briefcase-medical me-1"></i>{{ incident.get_treatment_level_display }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
