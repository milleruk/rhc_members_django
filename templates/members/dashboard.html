{% extends "base.html" %}
{% block title %}Player Dashboard{% endblock %}
{% block content %}
    <div class="content">
        <div class="container-fluid">
            <!-- HERO / ACTIONS -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="h4 mb-1">
                        <i class="fas fa-tachometer-alt mr-2"></i> Player Dashboard
                    </h2>
                    <p class="text-muted mb-0 small">Manage your players, memberships and tasks at a glance.</p>
                </div>
                <div class="d-flex flex-wrap">
                    <a href="{% url 'player_add' %}" class="btn btn-primary mr-2 mb-2">
                        <i class="fas fa-user-plus mr-1"></i> Add Player
                    </a>
                    <a href="{% url 'memberships:mine' %}"
                       class="btn btn-outline-secondary mb-2">
                        <i class="fas fa-id-card-alt mr-1"></i> My Memberships
                    </a>
                </div>
            </div>
            <!-- KPI WIDGETS -->
            <div class="row">
                <div class="col-6 col-md-3 mb-3">
                    <div class="kpi-box kpi-primary">
                        <div class="kpi-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value">{{ players|length }}</div>
                            <div class="kpi-label">Total Players</div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <a href="#" class="kpi-box kpi-accent">
                        <div class="kpi-icon">
                            <i class="fas fa-badge-check"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value">{{ active_subscriptions_count|default:0 }}</div>
                            <div class="kpi-label">Active Subscriptions</div>
                        </div>
                    </a>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <a href="{% url 'tasks:my_list' %}" class="kpi-box kpi-info">
                        <div class="kpi-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value">{{ pending_tasks|length|default:0 }}</div>
                            <div class="kpi-label">Open Tasks</div>
                        </div>
                    </a>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <a href="#" class="kpi-box kpi-dark">
                        <div class="kpi-icon">
                            <i class="fas fa-calendar-exclamation"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value">{{ spond_pending_count|default:0 }}</div>
                            <div class="kpi-label">Spond: Pending RSVPs</div>
                        </div>
                    </a>
                </div>
            </div>
            <!-- MEMBERSHIP CARDS HEADER (removed count badge) -->
            <div class="card card-outline mb-3">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-id-card-alt mr-1"></i> Membership Cards
                    </h3>
                </div>
                <div class="card-body py-2">
                    <p class="text-muted mb-0">View membership details and actions for each player. (Wallet passes coming soon.)</p>
                </div>
            </div>
            <div class="row">
                <!-- LEFT: PLAYER CARDS -->
                <div class="col-12 col-lg-8">
                    {% if players %}
                        <div class="row">
                            {% for p in players %}
                                <div class="col-12 col-md-6 mb-3">
                                    <div id="card-{{ p.public_id }}"
                                         class="membership-card shadow-sm"
                                         tabindex="0"
                                         aria-label="Membership card for {{ p.full_name|default:p }}"
                                         data-name="{{ p.full_name|default:p }}"
                                         data-number="RHC{{ p.membership_number }}"
                                         data-player-type="{{ p.player_type|default:'' }}"
                                         data-public-id="{{ p.public_id }}"
                                         data-email="{{ p.email|default:'' }}">
                                        <div class="mc-inner">
                                            <!-- FRONT -->
                                            <div class="mc-face mc-front">
                                                <!-- gradient bar -->
                                                <div class="mc-hero d-flex align-items-center justify-content-between">
                                                    <div class="d-flex align-items-center">
                                                        <div class="mc-avatar mr-2">
                                                            <span class="mc-initials">{{ p.first_name|default:"?"|slice:":1" }}{{ p.last_name|default:""|slice:":1" }}</span>
                                                        </div>
                                                        <div>
                                                            <div class="mc-name">{{ p.full_name|default:p }}</div>
                                                            <div class="mc-sub">
                                                                {% if p.player_type %}<span class="chip chip-soft mr-1">{{ p.player_type }}</span>{% endif %}
                                                                {% if p.get_relation_display %}<span class="chip chip-soft">{{ p.get_relation_display }}</span>{% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="mc-chip" title="Club chip"></div>
                                                </div>
                                                <!-- body -->
                                                <div class="mc-body">
                                                    <div class="mc-number" title="Membership number">
                                                        <i class="fas fa-id-card-alt mr-2"></i>RHC{{ p.membership_number }}
                                                    </div>
                                                    <div class="mc-badges mt-2">
                                                        {% if p.membership_status %}
                                                            <span class="badge {% if p.membership_status|lower == 'active' %}badge-success {% elif p.membership_status|lower == 'pending' %}badge-info {% else %}badge-dark{% endif %} mr-1">
                                                                {{ p.membership_status }}
                                                            </span>
                                                        {% endif %}
                                                        {% if p.membership_plan_label %}
                                                            <span class="badge badge-secondary mr-1">{{ p.membership_plan_label }}</span>
                                                        {% endif %}
                                                        {% if p.spond_pending_count %}
                                                            <span class="badge badge-warning" title="Spond responses pending">
                                                                <i class="fas fa-calendar-exclamation mr-1"></i>{{ p.spond_pending_count }} pending
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    {% with teams=p.team_memberships.all %}
                                                        {% if teams %}
                                                            <div class="mt-2 small text-muted">
                                                                <i class="fas fa-users mr-1"></i>
                                                                {% for m in teams|slice:":3" %}<span class="badge badge-light border mr-1">{{ m.team.name }}</span>{% endfor %}
                                                                {% if teams|length > 3 %}<span class="badge badge-light border">+{{ teams|length|add:"-3" }}</span>{% endif %}
                                                            </div>
                                                        {% endif %}
                                                    {% endwith %}
                                                    {% if p.answers_pct is not None %}
                                                        <div class="mt-3">
                                                            <div class="d-flex justify-content-between small mb-1">
                                                                <span class="text-muted">Profile completeness</span>
                                                                <span class="text-muted">{{ p.answers_pct }}%</span>
                                                            </div>
                                                            <div class="progress mc-progress">
                                                                <div class="progress-bar {% if p.answers_pct >= 80 %}bg-success {% elif p.answers_pct >= 40 %}bg-warning {% else %}bg-danger{% endif %}"
                                                                     role="progressbar"
                                                                     style="width: {{ p.answers_pct }}%"
                                                                     aria-valuenow="{{ p.answers_pct }}"
                                                                     aria-valuemin="0"
                                                                     aria-valuemax="100"></div>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                    <div class="mc-actions mt-3">
                                                        <a href="{% url 'answer' p.public_id %}"
                                                           class="btn btn-action btn-primary">
                                                            <i class="fas fa-edit mr-1"></i> Update Profile
                                                        </a>
                                                        <a href="{% url 'player_edit' public_id=p.public_id %}"
                                                           class="btn btn-action btn-outline-primary">
                                                            <i class="fas fa-user-cog mr-1"></i> Edit Details
                                                        </a>
                                                        <div class="dropdown ml-auto">
                                                            <button class="btn btn-action btn-icon mc-flip-btn"
                                                                    type="button"
                                                                    aria-label="More actions">
                                                                <i class="fas fa-ellipsis-h"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- BACK -->
                                            <div class="mc-face mc-back">
                                                <div class="small text-muted mb-2">Actions</div>
                                                <!-- Desktop / Tablet -->
                                                <div class="btn-group btn-group-sm d-none d-sm-flex flex-wrap">
                                                    <a class="btn btn-dark mb-2 mr-2"
                                                       href="{% url 'wallet:wallet_apple' p.public_id %}"
                                                       title="Download test Apple Wallet pass">
                                                        <i class="fab fa-apple mr-1"></i> Apple Wallet (test)
                                                    </a>
                                                    <button type="button"
                                                            class="btn btn-outline-danger mb-2"
                                                            onclick="return confirmDelete('{{ p.public_id }}', '{{ p.full_name|default:p|escapejs }}')">
                                                        <i class="fas fa-trash mr-1"></i> Remove
                                                    </button>
                                                </div>
                                                <!-- Mobile: Dropdown -->
                                                <div class="d-flex d-sm-none">
                                                    <div class="dropdown w-100">
                                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100"
                                                                type="button"
                                                                id="actionsMenu{{ forloop.counter }}"
                                                                data-toggle="dropdown"
                                                                aria-haspopup="true"
                                                                aria-expanded="false">Actions</button>
                                                        <div class="dropdown-menu dropdown-menu-right w-100"
                                                             aria-labelledby="actionsMenu{{ forloop.counter }}">
                                                            <a class="dropdown-item" href="{% url 'answer' p.public_id %}">
                                                                <i class="fas fa-edit mr-2"></i> Update Profile
                                                            </a>
                                                            <a class="dropdown-item"
                                                               href="{% url 'player_edit' public_id=p.public_id %}">
                                                                <i class="fas fa-user-cog mr-2"></i> Edit Details
                                                            </a>
                                                            <a class="dropdown-item"
                                                               href="{% url 'wallet:wallet_apple' p.public_id %}">
                                                                <i class="fab fa-apple mr-2"></i> Apple Wallet (test)
                                                            </a>
                                                            <div class="dropdown-divider"></div>
                                                            <button class="dropdown-item text-danger"
                                                                    type="button"
                                                                    onclick="return confirmDelete('{{ p.public_id }}', '{{ p.full_name|default:p|escapejs }}')">
                                                                <i class="fas fa-trash mr-2"></i> Remove
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Club strip + print -->
                                                <div class="mc-strip mt-3">
                                                    <div class="mc-note small">Club use only • Player ID: {{ p.public_id }}</div>
                                                </div>
                                                <button class="btn btn-sm btn-outline-secondary mt-3"
                                                        type="button"
                                                        onclick="printMembershipCard('{{ p.public_id }}')">
                                                    <i class="fas fa-print mr-1"></i> Print / PDF
                                                </button>
                                                <button class="btn btn-sm btn-light mt-3 mc-flip-btn" type="button">
                                                    <i class="fas fa-undo"></i> Back
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- hidden delete form -->
                                    <form id="delete-form-{{ p.public_id }}"
                                          action="{% url 'player_delete' p.public_id %}"
                                          method="post"
                                          style="display:none">
                                        {% csrf_token %}
                                    </form>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="card card-outline">
                            <div class="card-body">
                                <p class="mb-3">
                                    <i class="far fa-smile-wink mr-1"></i>No players yet. Add your first player to get started.
                                </p>
                                <a href="{% url 'player_add' %}" class="btn btn-primary"><i class="fas fa-user-plus mr-1"></i> Add Player</a>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <!-- RIGHT: TASKS / NOTICES / LINKS (unchanged placeholder) -->
                <!-- RIGHT: TASKS + CLUB NOTICES + QUICK LINKS -->
                <div class="col-12 col-lg-4">
                    <!-- Tasks (Todo List) -->
                    <div class="card card-outline card-info mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 class="card-title mb-0">
                                <i class="fas fa-bell mr-2"></i>Your Tasks
                            </h3>
                            <a href="{% url 'tasks:my_list' %}" class="small text-muted">View all</a>
                        </div>
                        <div class="card-body p-0">
                            {% if pending_tasks %}
                                <ul class="todo-list" data-widget="todo-list">
                                    {% for t in pending_tasks|slice:":8" %}
                                        <li>
                                            <span class="handle">
                                                <i class="fas fa-ellipsis-v"></i>
                                                <i class="fas fa-ellipsis-v"></i>
                                            </span>
                                            <div class="icheck-primary d-inline ml-2">
                                                <input type="checkbox" id="todoCheck{{ forloop.counter }}" disabled>
                                                <label for="todoCheck{{ forloop.counter }}"></label>
                                            </div>
                                            <span class="text">{{ t.title }} • {{ t.subject }}</span>
                                            {% if t.due_at %}
                                                <small class="badge badge-light border ml-2"><i class="far fa-clock mr-1"></i>{{ t.due_at|date:"D j M, H:i" }}</small>
                                            {% endif %}
                                            <div class="tools">
                                                {% if t.url %}
                                                    <a class="text-primary" href="{{ t.url }}" title="Open"><i class="fas fa-arrow-right"></i></a>
                                                {% else %}
                                                    <i class="far fa-circle text-muted" title="No link"></i>
                                                {% endif %}
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <div class="p-3 text-muted">
                                    <i class="far fa-check-circle mr-1"></i>Nothing urgent right now.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Club Notices (Collapsible card + callouts) -->
                    <div class="card card-outline card-warning mb-3">
                        <div class="card-header">
                            <h3 class="card-title mb-0">
                                <i class="fas fa-bullhorn mr-2"></i>Club Notices
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-2">
                            {% if notices %}
                                {% for n in notices %}
                                    <div class="callout callout-{% if n.level in 'warning danger info success' %}{{ n.level }}{% else %}info{% endif %} mb-2">
                                        <h5 class="mb-1">{{ n.title }}</h5>
                                        <p class="mb-1">{{ n.text }}</p>
                                        {% if n.url %}
                                            <a class="small" href="{{ n.url }}" target="_blank" rel="noopener">Learn more <i class="fas fa-external-link-alt ml-1"></i></a>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="callout callout-info mb-2">
                                    <h5 class="mb-1">No club notices</h5>
                                    <p class="mb-0 small text-muted">Announcements from the club will appear here.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Quick Links -->
                    <div class="card card-outline card-secondary">
                        <div class="card-header">
                            <h3 class="card-title mb-0">
                                <i class="fas fa-link mr-2"></i>Quick Links
                            </h3>
                        </div>
                        <div class="list-group list-group-flush">
                            {% if quick_links %}
                                {% for q in quick_links %}
                                    <a class="list-group-item list-group-item-action d-flex align-items-center"
                                       href="{{ q.url }}">
                                        {% if q.icon %}
                                            <i class="{{ q.icon }} mr-2"></i>
                                        {% else %}
                                            <i class="fas fa-external-link-alt mr-2"></i>
                                        {% endif %}
                                        <span>{{ q.label }}</span>
                                        <i class="fas fa-chevron-right ml-auto text-muted small"></i>
                                    </a>
                                {% endfor %}
                            {% else %}
                                <!-- sensible defaults -->
                                <a class="list-group-item list-group-item-action d-flex align-items-center"
                                   href="{% url 'memberships:mine' %}">
                                    <i class="fas fa-id-card-alt mr-2"></i><span>My Memberships</span>
                                    <i class="fas fa-chevron-right ml-auto text-muted small"></i>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex align-items-center"
                                   href="{% url 'player_add' %}">
                                    <i class="fas fa-user-plus mr-2"></i><span>Add a Player</span>
                                    <i class="fas fa-chevron-right ml-auto text-muted small"></i>
                                </a>
                                <a class="list-group-item list-group-item-action d-flex align-items-center"
                                   href="#">
                                    <i class="fas fa-file-alt mr-2"></i><span>Club Policies</span>
                                    <i class="fas fa-chevron-right ml-auto text-muted small"></i>
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- JS: confirm delete -->
        <script>
function confirmDelete(publicId, name) {
  if (confirm('Remove ' + name + '? This cannot be undone.')) {
    var f = document.getElementById('delete-form-' + publicId);
    if (f) { f.submit(); }
  }
  return false;
}
        </script>
        <!-- JS: flip interactions -->
        <script>
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.mc-flip-btn');
  if (!btn) return;
  const card = btn.closest('.membership-card');
  card.classList.toggle('is-flipped');
});

document.addEventListener('keydown', function(e) {
  if (!['Enter',' '].includes(e.key)) return;
  const active = document.activeElement;
  if (active && active.classList.contains('membership-card')) {
    e.preventDefault();
    active.classList.toggle('is-flipped');
  }
});
        </script>
        <!-- (printMembershipCard function & styles from your existing template stay as-is) -->
        <style>
  /* Theme tokens (align with your other pages) */
  :root{
    --accent:#3f8cff;
    --accent-2:#7c4dff;
    --accent-soft:#e8f1ff;
    --muted:#6c757d;
    --line:rgba(0,0,0,.08);
  }

  .card-outline{ border:1px solid var(--line); border-radius:.75rem; overflow:hidden; }

  /* KPI boxes */
  .kpi-box{
    display:flex; align-items:center;
    background:linear-gradient(180deg,#fff,#fafafa);
    border:1px solid var(--line); border-radius:.75rem;
    padding:.85rem .9rem; box-shadow:0 1px 0 rgba(0,0,0,.03);
    transition:transform .08s ease, box-shadow .12s ease;
    color:inherit; text-decoration:none;
  }
  .kpi-box:hover{ transform:translateY(-1px); box-shadow:0 4px 14px rgba(0,0,0,.06); text-decoration:none; }
  .kpi-icon{ width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-right:.7rem; }
  .kpi-content .kpi-value{ font-weight:800; font-size:1.25rem; line-height:1; }
  .kpi-content .kpi-label{ font-size:.9rem; color:var(--muted); }

  .kpi-primary .kpi-icon{ background:#e7f0ff; }
  .kpi-accent  .kpi-icon{ background:#efe9ff; }
  .kpi-info    .kpi-icon{ background:#e8f7ff; }
  .kpi-dark    .kpi-icon{ background:#f1f2f6; }
  .kpi-accent i{ color:#6b4eff; }
  .kpi-primary i{ color:#2e6ef9; }
  .kpi-info i{ color:#0ea5e9; }
  .kpi-dark i{ color:#111827; }

  /* Flip card engine */
  .membership-card{ position:relative; perspective:1000px; border-radius:14px; }
  .membership-card:focus{ outline:2px dashed rgba(0,0,0,.2); outline-offset:2px; }
  .mc-inner{ position:relative; width:100%; min-height:250px; transform-style:preserve-3d; transition:transform .6s cubic-bezier(.22,.61,.36,1); border-radius:14px; }
  .membership-card.is-flipped .mc-inner{ transform:rotateY(180deg); }
  .mc-face{ position:absolute; inset:0; border-radius:14px; border:1px solid rgba(0,0,0,.06); backface-visibility:hidden; background:#fff; }

  /* FRONT beautified */
  .mc-front{ overflow:hidden; }
  .mc-hero{
    padding:10px 12px;
    background:linear-gradient(135deg, var(--accent), var(--accent-2));
    color:#fff;
    border-top-left-radius:14px; border-top-right-radius:14px;
    border-bottom:1px solid rgba(255,255,255,.25);
  }
  .mc-avatar{
    width:44px;height:44px;border-radius:50%;
    display:inline-flex;align-items:center;justify-content:center;
    background:rgba(255,255,255,.15);
    border:2px solid rgba(255,255,255,.35); color:#fff; font-weight:700;
  }
  .mc-name{ font-size:1.08rem; font-weight:800; line-height:1.1; }
  .chip{ display:inline-flex;align-items:center;border:1px solid rgba(255,255,255,.35);border-radius:999px;padding:.1rem .5rem; font-size:.75rem; color:#fff; }
  .chip-soft{ background:rgba(255,255,255,.12); }
  .mc-chip{ width:36px;height:26px;border-radius:6px;background:linear-gradient(135deg,#c6cbd1,#9ea5ad);box-shadow:inset 0 0 0 2px rgba(255,255,255,.4),0 1px 2px rgba(0,0,0,.1); }

  .mc-body{ padding:12px; }
  .mc-number{
    display:inline-flex;align-items:center;font-variant-numeric:tabular-nums;
    letter-spacing:.05em;font-weight:800;background:#f8fafc;border:1px dashed rgba(0,0,0,.12);
    border-radius:8px;padding:6px 10px;
  }
  .mc-badges .badge{ vertical-align:middle; }

  .mc-progress{ height:8px;border-radius:6px;background:rgba(0,0,0,.05); }

  /* BACK */
  .mc-back{ transform:rotateY(180deg); }
  .mc-strip{ height:40px;border-radius:6px;background:#2c2c2c;display:flex;align-items:center;padding:0 10px; }
  .mc-note{ color:#e5e7eb; }

  /* Mobile niceties */
  @media (max-width:575.98px){
    .mc-inner{ min-height:260px; }
    .mc-name{ font-size:1.12rem; }
    .btn-group .btn,.mc-back .btn{ width:100%; }
    .mc-badges .badge{ margin-bottom:.25rem; }
    .d-flex.justify-content-between.align-items-center.mt-3{ flex-wrap:wrap; gap:.5rem; }
    .dropdown-menu.w-100{ min-width:100%!important; }
  }

  /* backface fixes */
  .mc-face{ -webkit-backface-visibility:hidden; backface-visibility:hidden; }

/* Tidy action buttons */
.mc-actions{
  display:flex; align-items:center; gap:.5rem;
}
.btn-action{
  padding:.45rem .7rem;
  border-radius:10px;
  font-weight:600;
  line-height:1.1;
  box-shadow:0 1px 0 rgba(0,0,0,.03);
}
.btn-action.btn-outline-primary{
  background:#fff;
  border-color:rgba(63,140,255,.35);
}
.btn-icon{
  width:36px; height:36px; padding:0;
  display:inline-flex; align-items:center; justify-content:center;
  border:1px solid rgba(0,0,0,.1);
  background:#fff;
}

/* Make buttons flow nicely on phones */
@media (max-width:575.98px){
  .mc-actions{
    flex-wrap:wrap;
  }
  .mc-actions .btn-action{
    flex:1 1 calc(50% - .25rem);
  }
  .mc-actions .btn-icon{
    flex:0 0 auto; /* keep kebab small */
  }
}

        </style>
    {% endblock %}
