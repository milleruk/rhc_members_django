{% extends "base.html" %}
{% block title %}Choose Membership{% endblock %}
{% block content %}
    <div class="container py-3">
        {% if has_active %}
            <div class="alert alert-warning mb-3">
                <i class="fas fa-exclamation-triangle me-1"></i>
                {{ existing_sub.product.name }} is already set for {{ season.name }}
                ({{ existing_sub.get_status_display }}).
                <a href="{% url 'memberships:mine' %}" class="alert-link">Manage membership</a>.
            </div>
        {% else %}
            <!-- Header / Season context -->
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-1"></i>
                <strong>{{ season.name }}</strong> — Select a membership for
                <strong>{{ player.first_name }} {{ player.last_name }}</strong>.
            </div>
            <!-- Optional quick filter/search -->
            <div class="row mb-3">
                <div class="col-12 col-md-6">
                    <div class="form-group mb-2">
                        <label class="small text-muted mb-1">Filter by category</label>
                        <select id="categoryFilter" class="form-control">
                            <option value="">All categories</option>
                            {% for product in products %}
                                {% ifchanged product.category.id %}
                                    <option value="cat-{{ product.category.id }}">{{ product.category.label }}</option>
                                {% endifchanged %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="form-group mb-2">
                        <label class="small text-muted mb-1">Search</label>
                        <input id="searchInput"
                               type="text"
                               class="form-control"
                               placeholder="Search product name…">
                    </div>
                </div>
            </div>
            <div class="row" id="productGrid">
                {% for product in products %}
                    <div class="col-12 col-md-6 col-xl-4 mb-3 product-card"
                         data-cat="cat-{{ product.category.id }}"
                         data-name="{{ product.name|lower }}">
                        <div class="card card-outline card-primary h-100 position-relative">
                            <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
                                <h4 class="card-title mb-0">
                                    <i class="fas fa-id-card-alt me-1"></i> {{ product.name }}
                                    <br>
                                    <br>
                                </h4>
                                <div class="card-tools d-flex flex-wrap">
                                    <span class="badge bg-secondary">{{ product.category.label }}</span>
                                    {% if product.active %}
                                        <span class="badge bg-success ms-1">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger ms-1">Inactive</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body d-flex flex-column">
                                {% if product.notes %}<p class="text-muted small mb-2">{{ product.notes }}</p>{% endif %}
                                <ul class="list-group list-group-flush mb-2">
                                    {% if product.list_price_gbp and product.list_price_gbp|floatformat != "0" %}
                                        <li class="list-group-item">
                                            <i class="fas fa-pound-sign me-1"></i>
                                            <strong>Membership fee:</strong> £{{ product.list_price_gbp }}
                                        </li>
                                    {% endif %}
                                    {% if product.pay_per_match %}
                                        <li class="list-group-item">
                                            <i class="fas fa-pound-sign me-1"></i>
                                            <strong>Match fee:</strong>
                                            {% if product.match_fee %}
                                                £{{ product.match_fee.amount_gbp }} ({{ product.match_fee.name }})
                                            {% else %}
                                                applies per game
                                            {% endif %}
                                        </li>
                                    {% endif %}
                                    <li class="list-group-item">
                                        <i class="fas fa-layer-group me-1"></i>
                                        {{ product.plans.count }} payment plan{{ product.plans.count|pluralize }}
                                    </li>
                                </ul>
                                {# Show up to 3 plan "chips" for a quick glance #}
                                {% if product.plans.all %}
                                    <div class="mb-3">
                                        {% for plan in product.plans.all|dictsort:"display_order"|slice:":3" %}
                                            <span class="badge bg-light text-dark border me-1 mb-1 d-inline-block">{{ plan.label }}</span>
                                        {% empty %}
                                            <span class="text-muted small">No plans configured yet.</span>
                                        {% endfor %}
                                        {% if product.plans.count > 3 %}
                                            <span class="badge bg-light text-dark border">+{{ product.plans.count|add:"-3" }}</span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                <div class="mt-auto d-grid">
                                    <a class="btn btn-primary btn-sm"
                                       href="{% url 'memberships:choose_plan' player.id product.id %}">
                                        {% if product.requires_plan and product.plans.count %}
                                            <i class="fas fa-list-ul me-1"></i> View payment plans
                                        {% else %}
                                            <i class="fas fa-check me-1"></i> Select
                                        {% endif %}
                                    </a>
                                </div>
                            </div>
                            <div class="card-footer d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Season: {{ product.season.name }}</span>
                                <span class="small text-muted">SKU: {{ product.sku }}</span>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="col-12">
                        <div class="alert alert-warning mb-0">No products available for this season / player type.</div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
    {# --- Tiny helpers (AdminLTE-compatible) --- #}
    <style>
  .ribbon-wrapper {
    position: absolute;
    top: -2px;
    right: 10px;
    width: 85px;
    height: 88px;
    overflow: hidden;
  }
  .ribbon {
    position: relative;
    left: 7px;
    top: 10px;
    width: 120px;
    padding: 5px 0;
    text-align: center;
    transform: rotate(45deg);
    box-shadow: 0 0 3px rgba(0,0,0,.3);
  }
  .product-card { display: block; }
  .product-card.hidden { display: none !important; }
    </style>
    <script>
  (function () {
    const cat = document.getElementById('categoryFilter');
    const q = document.getElementById('searchInput');
    const cards = Array.from(document.querySelectorAll('#productGrid .product-card'));

    function applyFilters() {
      const selected = cat ? cat.value : '';
      const term = q ? q.value.trim().toLowerCase() : '';

      cards.forEach(card => {
        const matchesCat = !selected || card.dataset.cat === selected;
        const matchesName = !term || (card.dataset.name || '').includes(term);
        card.classList.toggle('hidden', !(matchesCat && matchesName));
      });
    }

    if (cat) cat.addEventListener('change', applyFilters);
    if (q) q.addEventListener('input', applyFilters);
  })();
    </script>
{% endblock %}
