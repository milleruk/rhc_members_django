{% extends "base.html" %}
{% block title %}Confirm Membership{% endblock %}

{% block content %}
<div class="content-header pb-0">
  <div class="container-fluid">
    <div class="row mb-2 align-items-center">
      <div class="col-sm-7 d-flex align-items-center">
        <i class="fas fa-id-card-alt fa-lg text-primary mr-2"></i>
        <h1 class="m-0 h4">Confirm Membership</h1>
      </div>
      <div class="col-sm-5">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
          <li class="breadcrumb-item"><a href="{% url 'memberships:choose' player.id %}">Choose</a></li>
          <li class="breadcrumb-item active">Confirm</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">

  {# Surface any form errors nicely #}
  {% if form.errors or form.non_field_errors %}
    <div class="alert alert-danger">
      <h6 class="mb-2"><i class="icon fas fa-exclamation-triangle"></i> Please fix the issues below</h6>
      {{ form.non_field_errors }}
      <ul class="mb-0">
        {% for field in form %}
          {% for error in field.errors %}
            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div class="row">
    <div class="col-lg-7">
      <div class="card card-primary card-outline shadow-sm">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-user-check mr-2"></i>Membership Summary
          </h3>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-5 col-md-4">Player</dt>
            <dd class="col-7 col-md-8">
              <span class="badge badge-light border">
                {{ player.first_name }} {{ player.last_name }}
              </span>
            </dd>

            <dt class="col-5 col-md-4">Product</dt>
            <dd class="col-7 col-md-8">
              <span class="badge badge-info">{{ product.name }}</span>
              {% if product.pay_per_match %}
                <span class="ml-1 badge badge-secondary">Pay-per-match</span>
              {% endif %}
            </dd>

            <dt class="col-5 col-md-4">Season</dt>
            <dd class="col-7 col-md-8">{{ product.season.name }}</dd>

            <dt class="col-5 col-md-4">Payment</dt>
            <dd class="col-7 col-md-8">
              {% if plan %}
                <div class="mb-1">
                  <strong>{{ plan.label }}</strong>
                  — £{{ plan.instalment_amount_gbp|floatformat:2 }} × {{ plan.instalment_count }} ({{ plan.get_frequency_display }})
                  {% if plan.includes_match_fees %}
                    <span class="badge badge-success ml-1">Includes match fees</span>
                  {% endif %}
                </div>
                <div class="text-muted small">
                  {% if plan.first_payment_due %} • First payment due {{ plan.first_payment_due|date:"j M Y" }}{% endif %}
                </div>
              {% elif product.list_price_gbp and product.list_price_gbp|floatformat != "0" %}
                <div><strong>Membership fee:</strong> £{{ product.list_price_gbp|floatformat:2 }}</div>
              {% else %}
              {% endif %}

              {% if product.pay_per_match %}
                <div class="mt-2">
                  <strong>Match fee:</strong>
                  {% if match_fee %}
                    £{{ match_fee.amount_gbp|floatformat:2 }} <span class="text-muted">({{ match_fee.name }})</span>
                  {% else %}
                    applies per game
                  {% endif %}
                </div>
              {% endif %}
            </dd>

          <dt class="col-5 col-md-4">Notes</dt>
            <dd class="col-7 col-md-8">
              {{ product.notes }}

            </dd>
          </dl>

          <div class="callout callout-info mt-3 mb-0">
            <p class="mb-1"><i class="fas fa-info-circle mr-1"></i>
              Please check all details are correct before confirming your membership.
            </p>
            <p class="mb-0 small text-muted">
              By confirming, you enter into a membership agreement with Redditch Hockey Club for the stated season.
            </p>
          </div>
        </div>
      </div>

      <div class="card card-outline card-secondary shadow-sm">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-file-contract mr-2"></i>Membership Terms &amp; Conditions</h3>
          <div class="card-tools">
            <button class="btn btn-tool" type="button" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="p-3" style="max-height: 260px; overflow:auto;">
            <h6 class="font-weight-bold">1) Membership & Eligibility</h6>
            <p class="mb-2">Membership is for the season {{ product.season.name }} and is subject to Club rules, policies, codes of conduct, and selection processes. Junior players require parent/guardian consent.</p>

            <h6 class="font-weight-bold">2) Fees & Payments</h6>
            <p class="mb-2">You agree to pay membership fees as selected above. If paying by instalments, all instalments must be completed. Missed payments may result in suspension from training/matches until arrears are cleared.</p>

            <h6 class="font-weight-bold">3) Match Fees</h6>
            <p class="mb-2">Where applicable, match fees are payable per fixture as published by the Club. Concessionary rates (if any) are outlined on the Club website or communications.</p>

            <h6 class="font-weight-bold">4) Refunds & Cancellations</h6>
            <p class="mb-2">Membership fees are non-refundable once the season has begun, except where required by law or at the Club’s discretion in exceptional circumstances.</p>

            <h6 class="font-weight-bold">5) Conduct & Safeguarding</h6>
            <p class="mb-2">All members (and parents/guardians) must follow the Club Code of Conduct, Respect guidelines, and England Hockey policies, including safeguarding requirements.</p>

            <h6 class="font-weight-bold">6) Health & Fitness</h6>
            <p class="mb-2">You confirm you are fit to participate and will update the Club of any relevant medical information. In an emergency you consent to first aid being given and, where necessary, for medical treatment to be sought.</p>

            <h6 class="font-weight-bold">7) Training & Selection</h6>
            <p class="mb-2">Training attendance supports team selection. Selection remains at the coaches’/captains’ discretion in line with Club policy.</p>

            <h6 class="font-weight-bold">8) Photography & Media</h6>
            <p class="mb-2">The Club may take photos/videos for promotional use. If you (or your child) do not consent, please inform the Club in writing and via your profile settings.</p>

            <h6 class="font-weight-bold">9) Data Protection</h6>
            <p class="mb-2">We process personal data to manage membership and activities. See our Privacy Policy for full details and your rights.</p>

            <h6 class="font-weight-bold">10) Liability</h6>
            <p class="mb-2">The Club is not liable for loss or damage to personal property. Participation in hockey carries inherent risk which you accept by joining.</p>

            <h6 class="font-weight-bold">11) Changes</h6>
            <p class="mb-0">The Club may reasonably vary these terms during the season and will notify members of any material changes.</p>
          </div>
          <div class="border-top p-3 bg-light">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-toggle="modal" data-target="#fullTermsModal">
              <i class="fas fa-external-link-alt mr-1"></i>Open full terms
            </button>
          </div>
        </div>
      </div>
    </div>

    {# Right column: confirmation form #}
    <div class="col-lg-5">
      <div class="card card-success card-outline shadow-sm">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-check-circle mr-2"></i>Confirm & Submit</h3>
        </div>
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}

            {# Required T&Cs agreement checkbox (server should validate too) #}
            <div class="form-group">
            <div class="mb-3">
              {{ form|default_if_none:"" }}
            </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <a href="{% url 'memberships:choose' player.id %}" class="btn btn-default">
                <i class="fas fa-arrow-left mr-1"></i>Back
              </a>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-check mr-1"></i>Confirm Subscription
              </button>
            </div>
          </form>
        </div>
        <div class="card-footer bg-white">
          <div class="text-muted small">
            Need help? Contact your team captain or the Membership Secretary.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{# Modal with scrollable, print-friendly full terms #}
<div class="modal fade" id="fullTermsModal" tabindex="-1" aria-labelledby="fullTermsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary">
        <h5 class="modal-title text-white" id="fullTermsLabel"><i class="fas fa-file-contract mr-2"></i>Membership Terms &amp; Conditions</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        {# Duplicate or extend the summary terms here if you want longer copy #}
        <p class="text-muted small">Effective season: <strong>{{ product.season.name }}</strong></p>

        <h6 class="font-weight-bold">1) Membership & Eligibility</h6>
        <p>Membership applications are subject to approval. Junior memberships require parent/guardian consent and adherence to safeguarding policies.</p>

        <h6 class="font-weight-bold">2) Fees & Payment Plans</h6>
        <p>Fee amounts and any instalment schedules are shown on the confirmation page. Instalment agreements must be completed in full unless agreed with the Club in writing.</p>

        <h6 class="font-weight-bold">3) Match Fees</h6>
        <p>Where match fees apply, these are payable per fixture and may vary by team/competition. The Club will publish current rates.</p>

        <h6 class="font-weight-bold">4) Refunds, Pauses & Cancellations</h6>
        <p>Refunds are not normally issued once the season has begun. In exceptional cases (serious injury, relocation, etc.) the Committee may consider a partial refund or pause.</p>

        <h6 class="font-weight-bold">5) Conduct, Respect & Safeguarding</h6>
        <p>Members must uphold the Club Code of Conduct and England Hockey policies. Breaches may result in disciplinary action and/or membership suspension.</p>

        <h6 class="font-weight-bold">6) Health, Safety & Insurance</h6>
        <p>You are responsible for ensuring you are fit to participate. The Club carries appropriate insurance, but personal property is your responsibility.</p>

        <h6 class="font-weight-bold">7) Media & Photography</h6>
        <p>We may capture photos/videos for Club channels. Opt out by notifying the Club and adjusting your profile preferences.</p>

        <h6 class="font-weight-bold">8) Data Protection</h6>
        <p>We process your data for membership administration, fixtures, and safeguarding. See our Privacy Policy for full details and contact info.</p>

        <h6 class="font-weight-bold">9) Changes to Terms</h6>
        <p>We may update these terms; material changes will be communicated to members.</p>

        <hr>
        <p class="small text-muted mb-0">Questions? Contact the Membership Secretary.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">I Understand</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
