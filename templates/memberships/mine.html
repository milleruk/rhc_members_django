{% extends "base.html" %}
{% block title %}My Memberships{% endblock %}
{% block content %}
    <style>
  /* === Light / default theme tokens === */
  :root {
    --accent:#3f8cff;
    --accent-2:#7c4dff;
    --line:rgba(0,0,0,.08);
    --muted:#6c757d;

    --chip-bg:#f8f9fa;
    --chip-text:#212529;
    --chip-border:rgba(0,0,0,.1);
    --sep:rgba(0,0,0,.06);
    --avatar-bg:#f1f3f5;
    --avatar-text:#6c757d;
    --card-bg:#ffffff;
    --card-header-bg:#fafafa;
    --text-main:#212529;
  }

  /* === Dark mode overrides === */
  .dark-mode {
    --line:rgba(255,255,255,.1);
    --muted:#9ca3af;

    --chip-bg:#1f2937;
    --chip-text:#e5e7eb;
    --chip-border:rgba(255,255,255,.15);
    --sep:rgba(255,255,255,.12);
    --avatar-bg:#111827;
    --avatar-text:#9ca3af;
    --card-bg:#1e293b;
    --card-header-bg:#273244;
    --text-main:#e5e7eb;
  }

  /* === Card styling === */
  .card-outline {
    border:1px solid var(--line);
    border-radius:.75rem;
    overflow:hidden;
    background-color:var(--card-bg);
    color:var(--text-main);
  }
  .card-header {
    background:var(--card-header-bg);
    padding:.6rem .9rem;
    border-bottom:1px solid var(--line);
  }
  .card-title { font-size:1rem; line-height:1.2; margin:0; }
  .rounded-top-3{ border-top-left-radius:.75rem !important; border-top-right-radius:.75rem !important; }

  /* === Chips & badges === */
  .badge.chip {
    background-color:var(--chip-bg) !important;
    color:var(--chip-text) !important;
    border:1px solid var(--chip-border);
    font-weight:600;
  }
  .badge { vertical-align:middle; }

  /* === Avatar circles === */
  .avatar-circle {
    width:36px; height:36px; border-radius:50%;
    display:inline-flex; align-items:center; justify-content:center;
    background:var(--avatar-bg); border:1px solid var(--chip-border);
  }
  .avatar-initials { font-size:.8rem; font-weight:700; color:var(--avatar-text); }

  /* === Membership cards === */
  .membership-card .card-body { padding-bottom:.5rem; }
  .membership-card .card-footer { padding-top:.75rem; }
  .sep-top { border-top:1px solid var(--sep) !important; }

  /* === Utility === */
  .min-w-0{ min-width:0; }
  .font-weight-semibold{ font-weight:600; }

  /* === Mobile niceties === */
  @media (max-width:575.98px){
    .stack-xs > *{ width:100%; margin-right:0 !important; margin-bottom:.5rem; }
    .stack-xs > *:last-child{ margin-bottom:0; }
  }
    </style>
    <div class="content-header pb-0">
        <div class="container-fluid d-flex justify-content-between align-items-center flex-wrap">
            <h1 class="m-0">
                <i class="fas fa-id-card-alt mr-2"></i>My Memberships
            </h1>
            {% if current_season %}
                <span class="text-muted small mt-2 mt-sm-0">
                    Current season: <strong>{{ current_season.name }}</strong>
                </span>
            {% endif %}
        </div>
    </div>
    <section class="content">
        <div class="container-fluid">
            <!-- Players quick actions -->
            <div class="card card-outline mb-4 shadow-sm">
                <div class="card-header d-flex align-items-center justify-content-between rounded-top-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-friends mr-2"></i>Players you manage
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if players %}
                        <div class="list-group list-group-flush">
                            {% for p in players %}
                                <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                    <div class="d-flex align-items-center mr-2" style="min-width:0;">
                                        <div class="avatar-circle mr-2">
                                            <span class="avatar-initials">{{ p.first_name|default:"?"|slice:":1" }}{{ p.last_name|default:""|slice:":1" }}</span>
                                        </div>
                                        <div class="min-w-0">
                                            <strong class="text-truncate d-block">{{ p.first_name }} {{ p.last_name }}</strong>
                                            {% if p.player_type %}<span class="badge chip">{{ p.player_type }}</span>{% endif %}
                                        </div>
                                    </div>
                                    {# ===== Actions ===== #}
                                    <div>
                                        {% if not p.has_sub_this_season %}
                                            <a class="btn btn-outline-primary btn-sm"
                                               href="{% url 'memberships:choose' p.id %}">
                                                <i class="fas fa-plus me-1"></i> Choose membership
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="p-3 text-muted">No players found.</div>
                    {% endif %}
                </div>
            </div>
            <!-- Active & Pending -->
            <div class="card card-outline mb-4 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center rounded-top-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-check-circle mr-2"></i>Active &amp; Pending
                    </h5>
                    {% if active_subs %}<span class="badge badge-success">{{ active_subs|length }}</span>{% endif %}
                </div>
                {% if active_subs %}
                    <div class="card-body">
                        <div class="row">
                            {% for s in active_subs %}
                                <div class="col-12 col-lg-6 mb-3">
                                    <div class="card shadow-sm h-100 d-flex flex-column border-0 rounded-3 membership-card">
                                        <div class="card-body pb-2">
                                            <div class="d-flex justify-content-between align-items-start flex-wrap">
                                                <div class="min-w-0 mr-2">
                                                    <div class="font-weight-semibold text-truncate">{{ s.player.first_name }} {{ s.player.last_name }}</div>
                                                    <div class="small text-muted text-truncate">
                                                        {{ s.product.name }}
                                                        {% if s.product.season %}• {{ s.product.season.name }}{% endif %}
                                                    </div>
                                                </div>
                                                <span class="badge {% if s.status == 'active' %}badge-success {% elif s.status == 'pending' %}badge-info {% elif s.status == 'paused' %}badge-warning {% elif s.status == 'cancelled' %}badge-secondary {% else %}badge-dark{% endif %}">
                                                    {{ s.get_status_display }}
                                                </span>
                                            </div>
                                            <!-- Plan -->
                                            <div class="mt-3">
                                                <div class="small text-uppercase text-muted mb-1">Plan</div>
                                                {% if s.plan %}
                                                    <div class="d-flex flex-wrap align-items-center">
                                                        <span class="badge chip mr-1 mb-1">{{ s.plan.label }}</span>
                                                        {% if s.plan.instalment_count and s.plan.frequency %}
                                                            <span class="badge chip mr-1 mb-1">{{ s.plan.instalment_count }} × {{ s.plan.get_frequency_display }}</span>
                                                        {% endif %}
                                                        {% if s.plan.instalment_amount_gbp %}
                                                            <span class="badge badge-primary mr-1 mb-1">£{{ s.plan.instalment_amount_gbp }}</span>
                                                        {% endif %}
                                                        {% if s.plan.includes_match_fees %}
                                                            <span class="badge chip mr-1 mb-1">
                                                                <i class="fas fa-futbol mr-1"></i>Match fees included
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <div class="text-muted">No payment plan (one-off or £0 product)</div>
                                                {% endif %}
                                            </div>
                                            <!-- Dates -->
                                            <div class="mt-3 small text-muted">
                                                {% if s.started_at %}
                                                    <div>
                                                        <i class="far fa-calendar-check mr-1"></i>Started: {{ s.started_at|date:"j M Y" }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="card-footer bg-transparent mt-auto pt-2 sep-top rounded-bottom-3">
                                            {% if s.status != 'active' %}
                                                <div class="d-flex flex-wrap">
                                                    <form method="post"
                                                          action="{% url 'memberships:subscription_cancel' s.id %}"
                                                          class="d-inline mr-2 mb-2">
                                                        {% csrf_token %}
                                                        <button class="btn btn-outline-warning btn-sm"
                                                                onclick="return confirm('Cancel this membership?');">
                                                            <i class="fas fa-ban mr-1"></i> Cancel
                                                        </button>
                                                    </form>
                                                    <a class="btn btn-outline-danger btn-sm mb-2"
                                                       href="{% url 'memberships:subscription_delete' s.id %}">
                                                        <i class="fas fa-trash mr-1"></i> Delete
                                                    </a>
                                                </div>
                                            {% else %}
                                                <div class="text-muted small">
                                                    <i class="far fa-check-circle mr-1"></i> Active membership — approved by club admin.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="card-body text-muted">No active or pending memberships.</div>
                {% endif %}
            </div>
            <!-- Cancelled / Old -->
            <div class="card card-outline shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center rounded-top-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-archive mr-2"></i>Cancelled / Old
                    </h5>
                    {% if old_subs %}<span class="badge badge-secondary">{{ old_subs|length }}</span>{% endif %}
                </div>
                {% if old_subs %}
                    <div class="card-body">
                        <div class="row">
                            {% for s in old_subs %}
                                <div class="col-12 col-lg-6 mb-3">
                                    <div class="card shadow-sm h-100 border-0 rounded-3 membership-card">
                                        <div class="card-body pb-2">
                                            <div class="d-flex justify-content-between align-items-start flex-wrap">
                                                <div class="min-w-0 mr-2">
                                                    <div class="font-weight-semibold text-truncate">{{ s.player.first_name }} {{ s.player.last_name }}</div>
                                                    <div class="small text-muted text-truncate">
                                                        {{ s.product.name }}
                                                        {% if s.product.season %}• {{ s.product.season.name }}{% endif %}
                                                    </div>
                                                    {% if s.plan %}
                                                        <div class="small mt-2">
                                                            Plan: <span class="badge chip">{{ s.plan.label }}</span>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <span class="badge {% if s.status == 'cancelled' %}badge-secondary {% elif s.status == 'paused' %}badge-warning {% else %}badge-dark{% endif %}">
                                                    {{ s.get_status_display }}
                                                </span>
                                            </div>
                                            {% if s.started_at %}
                                                <div class="small text-muted mt-2">
                                                    <i class="far fa-calendar mr-1"></i>Started: {{ s.started_at|date:"j M Y" }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="card-body text-muted">No cancelled or old memberships.</div>
                {% endif %}
            </div>
        </div>
    </section>
{% endblock %}
