{% extends "base.html" %}
{% load socialaccount %} {# <-- IMPORTANT: loads provider_login_url & get_providers #}
{% block title %}Connected Accounts{% endblock %}

{% block content %}
<div class="container auth-wrap d-flex align-items-center justify-content-center py-5">
  <div class="auth-card" style="max-width:600px; width:100%;">

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-3">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <div class="card card-outline card-primary shadow-sm">
      <div class="card-header">
        <h3 class="card-title h6 mb-0">
          <i class="fas fa-plug mr-2"></i>Connected Accounts
        </h3>
      </div>

      <div class="card-body">
        <form method="post" action="{% url 'socialaccount_connections' %}">
          {% csrf_token %}

          {% if form.accounts %}
            <ul class="list-group mb-3">
              {% for base_account in form.accounts %}
                {% with account=base_account.get_provider_account %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>
                    <strong>{{ account.get_provider.name }}</strong>
                    <span class="text-muted">({{ account }})</span>
                  </span>
                  <label class="mb-0">
                    <input type="radio" name="account" value="{{ base_account.id }}">
                  </label>
                </li>
                {% endwith %}
              {% endfor %}
            </ul>
            <button type="submit" name="action_remove" class="btn btn-danger btn-sm">
              Remove Selected
            </button>
          {% else %}
            <p class="text-muted mb-3">No third-party accounts connected yet.</p>
          {% endif %}
        </form>

        <hr>
        <h6 class="mt-3">Add a new account</h6>
        {% get_providers as socialaccount_providers %} {# <-- safely fetch providers #}
        <div class="d-flex flex-wrap gap-2">
          {% for provider in socialaccount_providers %}
            <a href="{% provider_login_url provider.id process='connect' %}"
               class="btn btn-outline-primary btn-sm mr-2 mb-2">
              <i class="fab fa-{{ provider.id }} mr-1"></i>
              {{ provider.name }}
            </a>
          {% empty %}
            <p class="text-muted mb-0">No providers enabled yet.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <p class="text-center mt-3 mb-0">
      <a href="{% url 'accounts:settings' %}">Back to Settings</a>
    </p>
  </div>
</div>
{% endblock %}
