{% extends "base.html" %}
{% block title %}Spond Transactions{% endblock %}

{% block content %}
<div class="content-header pb-2">
  <div class="container-fluid">
    <div class="row mb-2 align-items-center">
      <div class="col-sm-6">
        <h1 class="m-0">Spond Transactions</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
          <li class="breadcrumb-item"><a href="{% url 'spond_integration:dashboard' %}">Spond</a></li>
          <li class="breadcrumb-item active">Transactions</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<section class="content">
  <div class="container-fluid">

    <!-- KPIs -->
    <div class="row">
      <div class="col-12 col-sm-6 col-md-3">
        <div class="info-box">
          <span class="info-box-icon bg-primary"><i class="fas fa-pound-sign"></i></span>
          <div class="info-box-content">
            <span class="info-box-text">Total (filtered)</span>
            <span class="info-box-number">£{{ kpi.total_amount_minor|floatformat:-2|divisibleby:100 }}</span>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-3">
        <div class="info-box">
          <span class="info-box-icon bg-info"><i class="fas fa-receipt"></i></span>
          <div class="info-box-content">
            <span class="info-box-text">Transactions</span>
            <span class="info-box-number">{{ kpi.count }}</span>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-3">
        <div class="info-box">
          <span class="info-box-icon bg-success"><i class="fas fa-check-circle"></i></span>
          <div class="info-box-content">
            <span class="info-box-text">Paid</span>
            <span class="info-box-number">£{{ kpi.paid_minor|floatformat:-2|divisibleby:100 }}</span>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-3">
        <div class="info-box">
          <span class="info-box-icon bg-warning"><i class="fas fa-hourglass-half"></i></span>
          <div class="info-box-content">
            <span class="info-box-text">Pending</span>
            <span class="info-box-number">£{{ kpi.pending_minor|floatformat:-2|divisibleby:100 }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card card-outline card-secondary">
      <div class="card-body">
        <form method="get" class="row g-2 align-items-end">
          <div class="col-md-4">
            <label class="form-label">Search</label>
            <input type="text" class="form-control" name="q" value="{{ q }}" placeholder="Player, member, reference, description">
          </div>
          <div class="col-md-2">
            <label class="form-label">Status</label>
            <select name="status" class="form-control">
              <option value="" {% if not status %}selected{% endif %}>Any</option>
              <option value="paid" {% if status == "paid" %}selected{% endif %}>Paid</option>
              <option value="pending" {% if status == "pending" %}selected{% endif %}>Pending</option>
              <option value="failed" {% if status == "failed" %}selected{% endif %}>Failed</option>
              <option value="refunded" {% if status == "refunded" %}selected{% endif %}>Refunded</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">When</label>
            <select name="when" class="form-control">
              <option value="7d" {% if when == "7d" %}selected{% endif %}>Last 7 days</option>
              <option value="30d" {% if when == "30d" %}selected{% endif %}>Last 30 days</option>
              <option value="all" {% if when == "all" %}selected{% endif %}>All</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Group/Subgroup</label>
            <select name="group" class="form-control">
              <option value="">All</option>
              {% for g in groups %}
                <option value="{{ g.id }}" {% if selected_group == g.id %}selected{% endif %}>
                  {{ g.name }} ({{ g.member_count }})
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-1 mt-3 mt-md-0">
            <button class="btn btn-primary w-100" type="submit">
              <i class="fas fa-search mr-1"></i> Go
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Transactions table -->
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <h3 class="card-title"><i class="fas fa-list mr-1"></i> Transactions</h3>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th>When</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Reference</th>
              <th>For</th>
              <th>Linked Player</th>
            </tr>
          </thead>
          <tbody>
            {% for t in transactions_page.object_list %}
              <tr>
                <td>
                  <div>{{ t.created_at|date:"D d M Y, H:i" }}</div>
                  {% if t.paid_at %}
                    <div class="small text-muted">Paid: {{ t.paid_at|date:"D d M Y, H:i" }}</div>
                  {% endif %}
                </td>
                <td>£{{ t.amount_minor|floatformat:-2|divisibleby:100 }} <span class="text-muted">{{ t.currency }}</span></td>
                <td>
                  {% if t.status == "paid" %}
                    <span class="badge bg-success">Paid</span>
                  {% elif t.status == "pending" %}
                    <span class="badge bg-warning text-dark">Pending</span>
                  {% elif t.status == "failed" %}
                    <span class="badge bg-danger">Failed</span>
                  {% elif t.status == "refunded" %}
                    <span class="badge bg-secondary">Refunded</span>
                  {% else %}
                    <span class="badge bg-light text-dark">{{ t.status }}</span>
                  {% endif %}
                </td>
                <td>
                  <div class="text-monospace small">{{ t.reference|default:"—" }}</div>
                  {% if t.description %}<div class="small text-muted">{{ t.description }}</div>{% endif %}
                </td>
                <td>
                  {% if t.spond_member %}
                    <div class="fw-semibold">{{ t.spond_member.full_name }}</div>
                    {% for g in t.spond_member.groups.all %}
                      <span class="badge bg-light text-dark border">{{ g.name }}</span>
                    {% endfor %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td>
                  {% if t.player %}
                    <a class="btn btn-sm btn-outline-primary"
                       href="{% url 'admin_player_detail' player_id=t.player.id %}">
                      {{ t.player.first_name }} {{ t.player.last_name }}
                    </a>
                  {% else %}
                    <span class="badge bg-warning text-dark">Unlinked</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-muted">No transactions match your filters.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="text-muted">
          Page {{ transactions_page.number }} of {{ transactions_page.paginator.num_pages }} · {{ transactions_page.paginator.count }} total
        </div>
        <nav>
          <ul class="pagination mb-0">
            {% if transactions_page.has_previous %}
              <li class="page-item"><a class="page-link" href="?q={{ q|urlencode }}&status={{ status }}&when={{ when }}{% if selected_group %}&group={{ selected_group }}{% endif %}&page={{ transactions_page.previous_page_number }}">&laquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}
            {% for p in transactions_page.paginator.page_range %}
              {% if p >= transactions_page.number|add:'-1' and p <= transactions_page.number|add:'1' %}
                {% if p == transactions_page.number %}
                  <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                {% else %}
                  <li class="page-item"><a class="page-link" href="?q={{ q|urlencode }}&status={{ status }}&when={{ when }}{% if selected_group %}&group={{ selected_group }}{% endif %}&page={{ p }}">{{ p }}</a></li>
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if transactions_page.has_next %}
              <li class="page-item"><a class="page-link" href="?q={{ q|urlencode }}&status={{ status }}&when={{ when }}{% if selected_group %}&group={{ selected_group }}{% endif %}&page={{ transactions_page.next_page_number }}">&raquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>

  </div>
</section>
{% endblock %}
