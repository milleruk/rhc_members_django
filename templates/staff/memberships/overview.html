{% extends "base.html" %}
{% block title %}Membership Overview{% endblock %}

{% block content %}
<div class="content-header py-2">
  <div class="container-fluid d-flex justify-content-between align-items-center">
    <div>
      <h1 class="m-0 h4">Membership Overview</h1>
      <p class="text-muted small mb-0">Snapshot of subscriptions and gaps.</p>
    </div>
    <div>
      <a class="btn btn-sm btn-outline-primary" href="{% url 'staff:memberships_list' %}">View All Subscriptions</a>
    </div>
  </div>
</div>

<section class="content">
  <div class="container-fluid">

    <!-- Filters -->
    <form class="mb-3">
      <div class="form-row">
        <div class="col-md-4">
          <label class="small text-muted mb-1">Season</label>
          <select name="season" class="form-control form-control-sm" onchange="this.form.submit()">
            <option value="">All</option>
            {% for s in seasons %}
              <option value="{{ s.id }}" {% if selected_season == s.id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="small text-muted mb-1">Product</label>
          <select name="product" class="form-control form-control-sm" onchange="this.form.submit()">
            <option value="">All</option>
            {% for p in products %}
              <option value="{{ p.id }}" {% if selected_product == p.id %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <a class="btn btn-sm btn-light ml-auto" href="{% url 'staff:memberships_overview' %}">Reset</a>
        </div>
      </div>
    </form>

    <!-- KPI cards -->
    <div class="row">
      <div class="col-sm-6 col-lg-3 mb-3">
        <div class="card card-outline card-success h-100"><div class="card-body">
          <div class="text-muted small">Active</div>
          <div class="h4 mb-0">{{ kpi.active }}</div>
        </div></div>
      </div>
      <div class="col-sm-6 col-lg-3 mb-3">
        <div class="card card-outline card-info h-100"><div class="card-body">
          <div class="text-muted small">Pending</div>
          <div class="h4 mb-0">{{ kpi.pending }}</div>
        </div></div>
      </div>
      <div class="col-sm-6 col-lg-3 mb-3">
        <div class="card card-outline card-warning h-100"><div class="card-body">
          <div class="text-muted small">Paused</div>
          <div class="h4 mb-0">{{ kpi.paused }}</div>
        </div></div>
      </div>
      <div class="col-sm-6 col-lg-3 mb-3">
        <div class="card card-outline card-danger h-100"><div class="card-body">
          <div class="text-muted small">Cancelled</div>
          <div class="h4 mb-0">{{ kpi.cancelled }}</div>
        </div></div>
      </div>
    </div>

    <div class="row">
      <!-- Breakdown tables -->
      <div class="col-lg-6 mb-3">
        <div class="card h-100">
          <div class="card-header"><h3 class="card-title h6 mb-0">By Product</h3></div>
          <div class="card-body p-0">
            <table class="table table-sm mb-0">
              <thead><tr><th>Product</th><th class="text-right">Subscriptions</th></tr></thead>
              <tbody>
                {% for row in by_product %}
                <tr>
                  <td>{{ row.product__name|default:"—" }}</td>
                  <td class="text-right">{{ row.total }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="2" class="text-muted p-3">No data.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-6 mb-3">
        <div class="card h-100">
          <div class="card-header"><h3 class="card-title h6 mb-0">By Season</h3></div>
          <div class="card-body p-0">
            <table class="table table-sm mb-0">
              <thead><tr><th>Season</th><th class="text-right">Subscriptions</th></tr></thead>
              <tbody>
                {% for row in by_season %}
                <tr>
                  <td>{{ row.season__name|default:"—" }}</td>
                  <td class="text-right">{{ row.total }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="2" class="text-muted p-3">No data.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Players without a current sub -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title h6 mb-0">Players without a current subscription</h3>
        <span class="badge badge-secondary">{{ no_current_count }}</span>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Player</th>
              <th>Type</th>
              <th>Teams</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for p in no_current_players %}
              <tr>
                <td>{{ p.first_name }} {{ p.last_name }}</td>
                <td>{{ p.player_type.name|default:"—" }}</td>
                <td>
                  {% for tm in p.team_memberships.all %}
                    <span class="badge badge-light mr-1 mb-1">{{ tm.team.name }}</span>
                  {% empty %}—{% endfor %}
                </td>
                <td class="text-right">
                  <a class="btn btn-xs btn-outline-primary" href="{% url 'memberships:choose' p.id %}">Assign</a>
                  <a class="btn btn-xs btn-outline-secondary" href="{% url 'staff:player_detail' p.id %}">Details</a>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-muted p-3">All set — everyone has a current sub.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</section>
{% endblock %}
