{% extends "base.html" %}
{% load members_extras %}
{% load static %}
{% block title %}Players{% endblock %}
{% block content %}
    <section class="content">
        <div class="container-fluid">
            <br>
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <!-- Header -->
                        <div class="card-header d-flex align-items-center">
                            <h3 class="card-title mb-0">Player List</h3>
                            <div class="card-tools">
                                <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}export=csv"
                                   class="btn btn-tool"
                                   title="Export CSV">
                                    <i class="fas fa-file-export"></i>
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filters -->
                            <form method="get" class="row g-2">
                                <div class="col-12 col-md-6">
                                    <label class="sr-only" for="filter-team">Team</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-users"></i></span>
                                        </div>
                                        <select id="filter-team"
                                                name="team"
                                                class="form-control"
                                                onchange="this.form.submit()">
                                            <option value="">All Teams</option>
                                            <option value="none" {% if request.GET.team == "none" %}selected{% endif %}>Unassigned</option>
                                            {% for team in teams %}
                                                <option value="{{ team.id }}"
                                                        {% if request.GET.team == team.id|stringformat:"s" %}selected{% endif %}>
                                                    {{ team.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="sr-only" for="filter-type">Type</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                                        </div>
                                        <select id="filter-type"
                                                name="player_type"
                                                class="form-control"
                                                onchange="this.form.submit()">
                                            <option value="">All Types</option>
                                            {% for pt in player_types %}
                                                <option value="{{ pt.id }}"
                                                        {% if request.GET.player_type == pt.id|stringformat:"s" %}selected{% endif %}>
                                                    {{ pt.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                {% if request.GET.team or request.GET.player_type %}
                                    <div class="col-12">
                                        <div class="mt-2">
                                            <span class="mr-2">Active filters:</span>
                                            {% if request.GET.team %}
                                                {% if request.GET.team == "none" %}
                                                    <a href="?{% if request.GET.player_type %}player_type={{ request.GET.player_type }}&{% endif %}{% if request.GET.subscription_status %}subscription_status={{ request.GET.subscription_status }}{% endif %}"
                                                       class="badge badge-primary">
                                                        Team: Unassigned <i class="fas fa-times ml-1"></i>
                                                    </a>
                                                {% else %}
                                                    <a href="?{% if request.GET.player_type %}player_type={{ request.GET.player_type }}&{% endif %}{% if request.GET.subscription_status %}subscription_status={{ request.GET.subscription_status }}{% endif %}"
                                                       class="badge badge-primary">
                                                        Team: {{ teams|get_item:request.GET.team|attr:"name"|default:"Selected" }} <i class="fas fa-times ml-1"></i>
                                                    </a>
                                                {% endif %}
                                            {% endif %}
                                            {% if request.GET.player_type %}
                                                <a href="?{% if request.GET.team %}team={{ request.GET.team }}{% endif %}"
                                                   class="badge badge-info">
                                                    Type: {{ player_types|get_item:request.GET.player_type|attr:"name"|default:"Selected" }} <i class="fas fa-times ml-1"></i>
                                                </a>
                                            {% endif %}
                                            <a href="." class="badge badge-secondary">Clear all</a>
                                        </div>
                                    </div>
                                {% endif %}
                            </form>
                            {% if debug_mode %}
                                <div class="alert alert-info small mt-3">
                                    <div>
                                        <strong>Debug:</strong>
                                    </div>
                                    <div>is_admin_all = {{ debug_global.is_admin_all }}</div>
                                    <div>captains_only = {{ debug_global.captains_only }}</div>
                                    <div>
                                        team param = "{{ debug_global.raw_team_param }}" → selected_team_id = {{ debug_global.selected_team_id|default:"—" }}
                                    </div>
                                    <div>allowed_team_ids = {{ debug_global.allowed_team_ids }}</div>
                                    <div>memberships_in_scope = {{ debug_global.memberships_in_scope }}</div>
                                    <div>visible_players_count = {{ debug_global.visible_players_count }}</div>
                                </div>
                            {% endif %}
                            <!-- Desktop/tablet: table (md and up) -->
                            <div class="table-responsive mt-3 d-none d-md-block">
                                <table class="table table-striped table-hover table-sm mb-0">
                                    <thead class="thead-light">
                                        <tr>
                                            <th style="min-width:200px;">Name</th>
                                            <th>Gender</th>
                                            <th>Type</th>
                                            <th>Teams</th>
                                            <th>Membership</th>
                                            <th class="text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for p in players %}
                                            <tr>
                                                <td class="align-middle">
                                                    <div class="d-flex align-items-center">
                                                        <div class="img-circle bg-primary d-inline-flex justify-content-center align-items-center mr-2"
                                                             style="width:28px;
                                                                    height:28px;
                                                                    color:#fff;
                                                                    font-weight:600">
                                                            {{ p.first_name|slice:":1" }}{{ p.last_name|slice:":1" }}
                                                        </div>
                                                        <a href="{% url 'staff:player_detail' p.id %}">{{ p.first_name }} {{ p.last_name }}</a>
                                                    </div>
                                                </td>
                                                <td class="align-middle">{{ p.get_gender_display }}</td>
                                                <td class="align-middle">
                                                    <span class="badge badge-pill badge-info">{{ p.player_type }}</span>
                                                </td>
                                                <td class="align-middle">
                                                    {% for m in p.team_memberships.all %}
                                                        <span class="badge badge-secondary mr-1 mb-1">{{ m.team.name }}</span>
                                                    {% empty %}—
                                                    {% endfor %}
                                                </td>
                                                <td class="align-middle">
                                                    {% if p.active_sub_product %}
                                                        <span class="badge badge-success">{{ p.active_sub_product }}</span>
                                                        <div class="small text-muted">{{ p.active_sub_season|default:"—" }} · {{ p.active_sub_status|title }}</div>
                                                    {% else %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                                </td>
                                                <td class="align-middle text-right">
                                                    <div class="btn-group">
                                                        {% if p.active_spond_count %}
                                                            <span class="btn btn-success btn-xs disabled">
                                                                <i class="fas fa-user mr-1"></i>Spond linked
                                                            </span>
                                                        {% endif %}
                                                        <a href="{% url 'staff:player_detail' p.id %}"
                                                           class="btn btn-primary btn-xs">
                                                            <i class="fas fa-eye mr-1"></i>View
                                                        </a>
                                                        {% if perms.spond_integrations.link_spond_app %}
                                                            <button class="btn btn-outline-primary btn-xs js-spond-link"
                                                                    data-toggle="modal"
                                                                    data-target="#spondLinker"
                                                                    data-player-id="{{ p.id }}">Link Spond</button>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="6" class="text-muted text-center py-4">No players match your filters.</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <!-- Mobile: card list (sm and down) -->
                            <div class="d-block d-md-none mt-3">
                                {% for p in players %}
                                    <div class="card mb-2 shadow-sm">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="d-flex align-items-center">
                                                    <div class="img-circle bg-primary d-inline-flex justify-content-center align-items-center mr-2"
                                                         style="width:36px;
                                                                height:36px;
                                                                color:#fff;
                                                                font-weight:700">
                                                        {{ p.first_name|slice:":1" }}{{ p.last_name|slice:":1" }}
                                                    </div>
                                                    <div>
                                                        <a class="font-weight-bold" href="{% url 'staff:player_detail' p.id %}">{{ p.first_name }} {{ p.last_name }}</a>
                                                        <div class="small text-muted">{{ p.get_gender_display }} · {{ p.player_type }}</div>
                                                    </div>
                                                </div>
                                                <!-- Action dropdown -->
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                                            type="button"
                                                            id="actions-{{ p.id }}"
                                                            data-toggle="dropdown"
                                                            aria-haspopup="true"
                                                            aria-expanded="false"
                                                            aria-label="Actions for {{ p.first_name }} {{ p.last_name }}">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <div class="dropdown-menu dropdown-menu-right"
                                                         aria-labelledby="actions-{{ p.id }}">
                                                        <a class="dropdown-item" href="{% url 'staff:player_detail' p.id %}">
                                                            <i class="fas fa-eye mr-2"></i> View profile
                                                        </a>
                                                        {% if perms.spond_integrations.link_spond_app %}
                                                            <button class="dropdown-item js-spond-link"
                                                                    data-toggle="modal"
                                                                    data-target="#spondLinker"
                                                                    data-player-id="{{ p.id }}">
                                                                <i class="fas fa-link mr-2"></i> Link Spond
                                                            </button>
                                                        {% endif %}
                                                        {% if p.active_spond_count %}
                                                            <div class="dropdown-divider"></div>
                                                            <span class="dropdown-item-text text-success"><i class="fas fa-user mr-2"></i> Spond linked</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Teams -->
                                            <div class="mt-2">
                                                {% for m in p.team_memberships.all %}
                                                    <span class="badge badge-secondary mr-1 mb-1">{{ m.team.name }}</span>
                                                {% empty %}
                                                    <span class="text-muted small">No team</span>
                                                {% endfor %}
                                            </div>
                                            <!-- Membership -->
                                            <div class="mt-1">
                                                {% if p.active_sub_product %}
                                                    <span class="badge badge-success">{{ p.active_sub_product }}</span>
                                                    <span class="small text-muted">· {{ p.active_sub_season|default:"—" }} · {{ p.active_sub_status|title }}</span>
                                                {% else %}
                                                    <span class="text-muted small">No active membership</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="text-muted text-center py-4">No players match your filters.</div>
                                {% endfor %}
                            </div>
                        </div>
                        {% if page_obj %}
                            <div class="card-footer bg-white d-flex justify-content-between align-items-center py-2">
                                <div>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</div>
                                <div>
                                    {% if page_obj.has_previous %}
                                        <a class="btn btn-outline-secondary btn-sm"
                                           href="?page={{ page_obj.previous_page_number }}{% if request.GET.team %}&team={{ request.GET.team }}{% endif %}{% if request.GET.player_type %}&player_type={{ request.GET.player_type }}{% endif %}">
                                            <i class="fas fa-chevron-left mr-1"></i>Previous
                                        </a>
                                    {% endif %}
                                    {% if page_obj.has_next %}
                                        <a class="btn btn-outline-secondary btn-sm ml-1"
                                           href="?page={{ page_obj.next_page_number }}{% if request.GET.team %}&team={{ request.GET.team }}{% endif %}{% if request.GET.player_type %}&player_type={{ request.GET.player_type }}{% endif %}">
                                            Next<i class="fas fa-chevron-right ml-1"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Single Spond Linker modal include (once) -->
    {% if perms.spond_integrations.link_spond_app %}
        {% include "spond_integration/_link_modal.html" %}
    {% endif %}
    <style>
  /* small spacing tweaks for touch targets */
  .dropdown-menu .dropdown-item { padding: .5rem .75rem; }
  .badge + .badge { margin-left: .25rem; }
    </style>
    <script>
  // Set hidden input whenever a "Link Spond" trigger is clicked (works for table + mobile cards)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.js-spond-link');
    if (!btn) return;
    const pid = btn.getAttribute('data-player-id') || '';
    const hid = document.getElementById('spondPlayerId');
    if (hid) hid.value = pid;
  });

  // Optional: focus search and kick an initial search when modal opens
  document.addEventListener('shown.bs.modal', function(ev){
    if (ev.target && ev.target.id === 'spondLinker') {
      const input = document.getElementById('spondSearch');
      if (input) input.focus();
      if (window.SpondSearch && typeof window.SpondSearch.initialSearch === 'function') {
        window.SpondSearch.initialSearch();
      }
    }
  });
    </script>
{% endblock %}
