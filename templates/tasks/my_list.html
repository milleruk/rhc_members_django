{% extends "base.html" %}
{% load static %}
{% block title %}My Tasks{% endblock %}
{% block content %}
    <section class="content">
        <div class="container-fluid">
            <!-- Header / Quick actions -->
            <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                <h1 class="h4 m-0">
                    <i class="fas fa-tasks mr-2"></i> My Tasks
                </h1>
                <div class="ml-auto d-flex flex-wrap gap-2">
                    {% if perms.tasks.add_task %}
                        <a class="btn btn-primary btn-sm rounded-pill shadow-sm"
                           href="{% url 'tasks:create' %}">
                            <i class="fas fa-plus-circle mr-1"></i> New Task
                        </a>
                        <a class="btn btn-outline-primary btn-sm rounded-pill shadow-sm"
                           href="{% url 'tasks:bulk_generate' %}">
                            <i class="fas fa-bolt mr-1"></i> Generate
                        </a>
                    {% endif %}
                </div>
            </div>
            <!-- Filters -->
            <div class="card card-soft rounded-3 shadow-sm mb-3 border-0">
                <div class="card-body py-3">
                    <form class="d-flex flex-wrap align-items-center gap-2">
                        <div class="input-group input-group-sm smart-rounded">
                            <input type="text"
                                   name="q"
                                   class="form-control"
                                   placeholder="Search tasks..."
                                   value="{{ request.GET.q|default_if_none:'' }}"
                                   aria-label="Search tasks">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="submit" aria-label="Search">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <select name="status"
                                class="form-control form-control-sm smart-rounded"
                                onchange="this.form.submit()"
                                aria-label="Filter by status">
                            <option value="">Status: Any</option>
                            {% for code, label in status_choices %}
                                <option value="{{ code }}"
                                        {% if request.GET.status %} {% if request.GET.status == code %}selected{% endif %}
                                        {% else %}
                                        {% if code == 'open' %}selected{% endif %}
                                        {% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        <select name="due"
                                class="form-control form-control-sm smart-rounded"
                                aria-label="Filter by due">
                            <option value="">Due: Any</option>
                            <option value="overdue"
                                    {% if request.GET.due == 'overdue' %}selected{% endif %}>Overdue</option>
                            <option value="week" {% if request.GET.due == 'week' %}selected{% endif %}>This week</option>
                            <option value="future"
                                    {% if request.GET.due == 'future' %}selected{% endif %}>Future</option>
                            <option value="none" {% if request.GET.due == 'none' %}selected{% endif %}>No due date</option>
                        </select>
                        <a href="{% url 'tasks:my_list' %}"
                           class="btn btn-outline-secondary btn-sm ml-auto smart-rounded">
                            <i class="fas fa-redo mr-1"></i> Reset
                        </a>
                    </form>
                </div>
            </div>
            <!-- Grid -->
            <div class="row">
                {% if tasks %}
                    {% for t in tasks %}
                        <div class="col-12 col-md-6 col-xl-4 d-flex">
                            <div id="task-{{ t.id }}"
                                 class="card project-card card-soft flex-fill rounded-3 shadow-sm mb-3 border-0 {% if t.is_overdue %}border border-danger subtle-danger{% endif %}">
                                <div class="card-header border-0 bg-transparent pb-2">
                                    <div class="d-flex align-items-start w-100">
                                        <!-- Status badge -->
                                        <div class="mr-2">
                                            {% if t.status == 'open' %}
                                                <span class="badge badge-soft-warning">
                                                    <i class="fas fa-clock mr-1"></i> Open
                                                </span>
                                            {% elif t.status == 'done' %}
                                                <span class="badge badge-soft-success">
                                                    <i class="fas fa-check mr-1"></i> Done
                                                </span>
                                            {% else %}
                                                <span class="badge badge-soft-secondary">
                                                    <i class="fas fa-eye-slash mr-1"></i> Dismissed
                                                </span>
                                            {% endif %}
                                        </div>
                                        <!-- Title -->
                                        <h5 class="card-title mb-0 text-wrap pr-2">{{ t.title }}</h5>
                                        <!-- Due badge -->
                                        <div class="ml-auto">
                                            {% if t.due_at %}
                                                <span class="badge {% if t.is_overdue %}badge-soft-danger{% else %}badge-soft-info{% endif %}">
                                                    <i class="far fa-calendar-alt mr-1"></i>
                                                    {{ t.due_at|date:"D j M, H:i" }}
                                                </span>
                                            {% else %}
                                                <span class="badge badge-soft-light">
                                                    <i class="far fa-calendar-alt mr-1"></i> No due
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body pt-0">
                                    {% if t.description %}<p class="text-muted small mb-2">{{ t.description }}</p>{% endif %}
                                    {% if t.subject_link %}
                                        <div class="small mb-3">
                                            <i class="fas fa-link mr-1 text-muted"></i>
                                            â€¢ {{ t.subject_link|safe }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer d-flex align-items-center justify-content-between bg-transparent">
                                    <!-- Assignee -->
                                    <div class="d-flex align-items-center">
                                        <span class="mr-2 d-flex align-items-center justify-content-center avatar-soft">
                                            <i class="fas fa-user-circle fa-lg text-muted"></i>
                                        </span>
                                        <div class="small">
                                            <span class="text-muted d-block">Assigned to</span>
                                            <strong>{{ t.assigned_to|default:"Unassigned" }}</strong>
                                        </div>
                                    </div>
                                    <!-- Actions -->
                                    <div class="btn-group">
                                        {% if t.status == 'open' %}
                                            {% if not t.allow_manual_complete %}
                                                <span class="btn btn-sm btn-outline-light text-muted smart-rounded"
                                                      title="Auto-completes when its event triggers">
                                                    <i class="fas fa-robot mr-1"></i> Auto
                                                </span>
                                            {% elif t.can_complete %}
                                                <form action="{% url 'tasks:complete' t.pk %}"
                                                      method="post"
                                                      class="d-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                                    <button type="submit" class="btn btn-sm btn-success smart-rounded">
                                                        <i class="fas fa-check mr-1"></i> Complete
                                                    </button>
                                                </form>
                                                <form action="{% url 'tasks:dismiss' t.pk %}"
                                                      method="post"
                                                      class="d-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-secondary smart-rounded">
                                                        <i class="fas fa-eye-slash mr-1"></i> Dismiss
                                                    </button>
                                                </form>
                                            {% else %}
                                                <span class="btn btn-sm btn-outline-light text-muted smart-rounded"
                                                      title="Assigned to another user">
                                                    <i class="far fa-hourglass mr-1"></i> Waiting
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="btn btn-sm btn-outline-light text-muted smart-rounded"
                                                  disabled>
                                                <i class="far fa-check-circle mr-1"></i> Completed
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="card card-soft rounded-3 shadow-sm border-0 text-center py-5">
                            <div class="card-body">
                                <i class="far fa-smile fa-3x text-muted mb-3 d-block"></i>
                                <p class="lead mb-1">No open tasks â€” nice!</p>
                                <p class="text-muted mb-0">Youâ€™ll see tasks here when theyâ€™re assigned to you.</p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </section>
    <!-- Focus ring + minor theming helpers -->
    <script>
  (function () {
    const params = new URLSearchParams(window.location.search);
    const focus = params.get('focus');
    if (!focus) return;
    const el = document.getElementById('task-' + focus);
    if (!el) return;
    el.classList.add('ring-focus');
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => el.classList.remove('ring-focus'), 2500);
  })();
    </script>
{% endblock %}
